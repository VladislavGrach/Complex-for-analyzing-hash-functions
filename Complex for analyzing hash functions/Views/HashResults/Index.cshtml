@model IEnumerable<Complex_for_analyzing_hash_functions.Models.HashTestResult>
@using System.Text.Json;

<div class="container py-4">
    <div class="d-flex align-items-baseline justify-content-between flex-wrap gap-2 mb-3">
        <div>
            <h2 class="h4 mb-1">Список результатов тестирования</h2>
            <p class="text-muted small mb-0">История запусков и просмотр статистики по каждому эксперименту.</p>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" style="width: 80px;">ID</th>
                            <th scope="col" style="min-width: 170px;">Дата</th>
                            <th scope="col" style="min-width: 140px;">Алгоритм</th>
                            <th scope="col" style="width: 110px;">Раунды</th>
                            <th scope="col" style="width: 110px;">Тестов</th>
                            <th scope="col" style="width: 170px;"></th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var r in Model)
                        {
                            JsonElement raw;
                            try
                            {
                                raw = JsonSerializer.Deserialize<JsonElement>(r.BitFlipJson);
                            }
                            catch
                            {
                                raw = default;
                            }

                            var json = (raw.ValueKind != JsonValueKind.Undefined && raw.ValueKind != JsonValueKind.Null)
                            ? Complex_for_analyzing_hash_functions.Helpers.JsonUtils.NormalizeToObject(raw)
                            : default;

                            <tr>
                                <td>@r.Id</td>
                                <td class="text-nowrap">@r.RunDate</td>
                                <td>@r.Algorithm</td>
                                <td>@r.Rounds</td>
                                <td>@r.TestsCount</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#details-@r.Id"
                                            aria-expanded="false"
                                            aria-controls="details-@r.Id">
                                        Показать детали
                                    </button>
                                </td>
                            </tr>

                            <tr class="collapse bg-light" id="details-@r.Id">
                                <td colspan="6" class="p-3 p-md-4">

                                    @if (json.ValueKind == JsonValueKind.Undefined || json.ValueKind == JsonValueKind.Null)
                                    {
                                        <div class="text-muted">Не удалось прочитать JSON статистики.</div>
                                    }
                                    else
                                    {
                                        <div class="row g-3 g-lg-4">

                                            <!-- BASIC -->
                                            @if (json.TryGetProperty("Basic", out var basic) && basic.ValueKind == JsonValueKind.Object)
                                            {
                                                <div class="col-12">
                                                    <div class="border rounded-3 bg-white p-3">
                                                        <h3 class="h6 mb-2">Basic</h3>
                                                        <div class="table-responsive">
                                                            <table class="table table-sm mb-0">
                                                                <tbody>
                                                                    @foreach (var prop in basic.EnumerateObject())
                                                                    {
                                                                        <tr>
                                                                            <th class="text-nowrap" style="width: 220px;">@prop.Name</th>
                                                                            <td style="white-space: pre-wrap;">@prop.Value</td>
                                                                        </tr>
                                                                    }
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            }

                                            <!-- NIST -->
                                            @if (json.TryGetProperty("NIST", out var nist) && nist.ValueKind == JsonValueKind.Object)
                                            {
                                                <div class="col-lg-6">
                                                    <div class="border rounded-3 bg-white p-3 h-100">
                                                        <h3 class="h6 mb-2">NIST</h3>
                                                        <ul class="list-group list-group-flush small">
                                                            @foreach (var test in nist.EnumerateObject())
                                                            {
                                                                <li class="list-group-item d-flex justify-content-between gap-3">
                                                                    <span class="text-nowrap"><strong>@test.Name</strong></span>
                                                                    <span class="text-end" style="white-space: pre-wrap;">@test.Value</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            }

                                            <!-- DIEHARD -->
                                            @if (json.TryGetProperty("Diehard", out var dh) && dh.ValueKind == JsonValueKind.Object)
                                            {
                                                <div class="col-lg-6">
                                                    <div class="border rounded-3 bg-white p-3 h-100">
                                                        <h3 class="h6 mb-2">Diehard</h3>
                                                        <ul class="list-group list-group-flush small">
                                                            @foreach (var test in dh.EnumerateObject())
                                                            {
                                                                <li class="list-group-item d-flex justify-content-between gap-3">
                                                                    <span class="text-nowrap"><strong>@test.Name</strong></span>
                                                                    <span class="text-end" style="white-space: pre-wrap;">@test.Value</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            }

                                            <!-- TESTU01 -->
                                            @if (json.TryGetProperty("TestU01", out var u01) && u01.ValueKind == JsonValueKind.Object)
                                            {
                                                <div class="col-lg-6">
                                                    <div class="border rounded-3 bg-white p-3 h-100">
                                                        <h3 class="h6 mb-2">TestU01</h3>
                                                        <ul class="list-group list-group-flush small">
                                                            @foreach (var test in u01.EnumerateObject())
                                                            {
                                                                <li class="list-group-item d-flex justify-content-between gap-3">
                                                                    <span class="text-nowrap"><strong>@test.Name</strong></span>
                                                                    <span class="text-end" style="white-space: pre-wrap;">@test.Value</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            }

                                            <!-- AVALANCHE -->
                                            @if (json.TryGetProperty("Avalanche", out var avalanche) && avalanche.ValueKind == JsonValueKind.Object)
                                            {
                                                <div class="col-lg-6">
                                                    <div class="border rounded-3 bg-white p-3 h-100">
                                                        <h3 class="h6 mb-2">Avalanche</h3>
                                                        <ul class="list-group list-group-flush small">
                                                            @foreach (var test in avalanche.EnumerateObject())
                                                            {
                                                                <li class="list-group-item d-flex justify-content-between gap-3">
                                                                    <span class="text-nowrap"><strong>@test.Name</strong></span>
                                                                    <span class="text-end" style="white-space: pre-wrap;">@test.Value</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            }

                                            <!-- BIC -->
                                            @if (json.TryGetProperty("BIC", out var bic) && bic.ValueKind == JsonValueKind.Object)
                                            {
                                                <div class="col-lg-6">
                                                    <div class="border rounded-3 bg-white p-3 h-100">
                                                        <h3 class="h6 mb-2">BIC</h3>
                                                        <ul class="list-group list-group-flush small">
                                                            @foreach (var test in bic.EnumerateObject())
                                                            {
                                                                <li class="list-group-item d-flex justify-content-between gap-3">
                                                                    <span class="text-nowrap"><strong>@test.Name</strong></span>
                                                                    <span class="text-end" style="white-space: pre-wrap;">@test.Value</span>
                                                                </li>
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                            }

                                            <div class="col-12">
                                                <details class="border rounded-3 bg-white p-3">
                                                    <summary class="fw-semibold">Полный JSON</summary>
                                                    <pre class="mt-3 mb-0 small" style="white-space: pre-wrap;">@r.BitFlipJson</pre>
                                                </details>
                                            </div>

                                        </div>
                                    }
                                </td>
                            </tr>
                        }

                        @if (Model == null || !Model.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    Результатов пока нет.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
