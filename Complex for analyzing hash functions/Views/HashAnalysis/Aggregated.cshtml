@model List<Complex_for_analyzing_hash_functions.Models.RoundStatisticAggregatedPoint>

@{
    ViewData["Title"] = "Анализ по раундам";
    var suite = ViewBag.Suite as string ?? "diff";
}

<div class="mb-4">
    <h2 class="fw-semibold">Анализ свойств хэш-функции по числу раундов</h2>

    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <form method="get" class="row g-2 align-items-center">
            <input type="hidden" name="suite" id="suiteInput" value="@suite" />

            <div class="col-auto">
                <label class="col-form-label">Алгоритм:</label>
            </div>

            <div class="col-auto">
                <select name="algorithm" class="form-select" onchange="this.form.submit()">
                    <option value="Keccak" selected="@(ViewBag.Algorithm == "Keccak")">Keccak</option>
                    <option value="Blake" selected="@(ViewBag.Algorithm == "Blake")">BLAKE-256</option>
                    <option value="Blake2s" selected="@(ViewBag.Algorithm == "Blake2s")">BLAKE2s</option>
                    <option value="Blake2b" selected="@(ViewBag.Algorithm == "Blake2b")">BLAKE2b</option>
                    <option value="Blake3" selected="@(ViewBag.Algorithm == "Blake3")">BLAKE3</option>
                </select>
            </div>
        </form>
    </div>
</div>

<!-- ===== ВКЛАДКИ ===== -->
<div class="mb-4">
    <label class="form-label fw-semibold">Группа тестов:</label><br />

    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="suiteRadio" value="diff" @(suite == "diff" ? "checked" : "")>
        <label class="form-check-label">SAC / BIC</label>
    </div>

    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="suiteRadio" value="nist" @(suite == "nist" ? "checked" : "")>
        <label class="form-check-label">NIST</label>
    </div>

    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="suiteRadio" value="diehard" @(suite == "diehard" ? "checked" : "")>
        <label class="form-check-label">Diehard</label>
    </div>

    <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="suiteRadio" value="testu01" @(suite == "testu01" ? "checked" : "")>
        <label class="form-check-label">TestU01</label>
    </div>
</div>


<!-- ===== SAC + BIC ===== -->
<div class="suite-group" data-suite="diff">
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Avalanche Effect</h5>
                    <canvas id="sacChart" height="140"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Bit Independence Criterion</h5>
                    <canvas id="bicChart" height="140"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== NIST ===== -->
<div class="suite-group d-none" data-suite="nist">
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title">NIST Statistical Test Suite</h5>
            <canvas id="monobitChart" height="140"></canvas>
        </div>
    </div>
</div>

<!-- Заглушки под будущие батареи -->
<div class="suite-group d-none" data-suite="diehard">
    <div class="alert alert-secondary">Графики Diehard будут добавлены сюда</div>
</div>

<div class="suite-group d-none" data-suite="testu01">
    <div class="alert alert-secondary">Графики TestU01 будут добавлены сюда</div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const rounds = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.Rounds)));

        const sacMean  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.MeanFlipRateMean)));
        const sacCi    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.MeanFlipRateCi)));
        const sacUpper = sacMean.map((m, i) => m + sacCi[i]);
        const sacLower = sacMean.map((m, i) => m - sacCi[i]);

        const bicMean  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.BicMaxCorrelationMean)));
        const bicCi    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.BicMaxCorrelationCi)));
        const bicUpper = bicMean.map((m, i) => m + bicCi[i]);
        const bicLower = bicMean.map((m, i) => m - bicCi[i]);

        const monoMean  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.MonobitMean)));
        const monoCi    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(x => x.MonobitCi)));
        const monoUpper = monoMean.map((m, i) => m + monoCi[i]);
        const monoLower = monoMean.map((m, i) => m - monoCi[i]);
    </script>

    <script src="~/js/hash-analysis.js"></script>
}
